{% extends "layout.html" %}

{% block title %}
    {{ room.name }} - StudyBud
{% endblock %}

<!-- Right Sidebar -->
{% block rightSidebar %}
  <!-- Right Column: Participants -->
        {% comment %} <div class="col-lg-3 border-start border-secondary d-none d-lg-block h-100 overflow-auto"> {% endcomment %}
            <div class="p-3 border-bottom border-secondary">
                <h6 class="mb-0">
                    <i class="bi bi-people-fill me-2"></i>
                    PARTICIPANTS ({{ room.participants.count }})
                </h6>
            </div>
            <div class="participant-list">
                {% for participant in participants %}
                <div class="d-flex align-items-center p-2 border-bottom border-secondary">
                    <img src="{{ participant.avatar.url }}" style="object-fit: cover; width: 40px; height: 40px;" 
                         class="rounded-circle me-2" alt="Participant Avatar">
                    <div>
                        <h6 class="mb-0 text-white"><a href="{% url 'public-profile' participant.id %}" class="">@{{ participant.name }}</a></h6>
                        <small class="text-secondary">bio: {{ participant.bio|truncatewords:5 }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% comment %} </div> {% endcomment %}

{% endblock rightSidebar %}

{% block content %}
<div class="container-fluid d-flex flex-column min-vh-100 bg-dark relative">
    <!-- Top Bar -->
    <div class="row py-3 align-items-center border-bottom border-secondary sticky-top bg-dark" style="height: 89.1px;"> 
        <div class="col-auto">
            <div onclick="history.back()" class="text-white text-decoration-none" style="cursor: pointer;">
                <i class="bi bi-arrow-left-circle-fill fs-4"></i>
            </div>
        </div>
        <div class="col">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 text-uppercase fw-bold">{{ room.name }}</h5>
                <span class="badge bg-primary rounded-pill ms-2">{{ room.topic.name }}</span>
            </div>
        </div>
      
    </div>

    <div class="row flex-grow-1 overflow-hidden">
        <!-- Left Column: Messages -->
        <div class="d-flex flex-column h-100 ">
            <!-- Room Info -->
            <div class="p-3 border-bottom border-secondary">
                <div class="d-flex align-items-center mb-2">
                    <img src="{{ room.host.avatar.url }}" 
                         class="rounded-circle me-2" style="object-fit: cover; width: 40px; height: 40px;" alt="Host Avatar">
                    <div>
                        <p class="mb-0 text-secondary">Hosted by</p>
                        <h6 class="mb-0 text-info">@{{ room.host.name }}</h6>
                    </div>
                    <div class="ms-auto text-end">
                        <p class="mb-0 text-secondary"><i class="bi bi-clock-history"></i> Created {{ room.created_at|timesince }} ago</p>
                        <p class="mb-0 text-secondary"><i class="bi bi-people-fill"></i> {{ room.participants.count }} joined</p>
                    </div>
                </div>
                <p class="mb-0 text-white-50">{{ room.description }}</p>
            </div>
            
            {% if user.is_authenticated %}
            <!-- Message Input -->
            <div class="p-3 border-top border-secondary mt-auto">
                <form method="POST" action="" class="d-flex gap-2">
                    {% csrf_token %}
                    <div class="input-group">
                        <span class="input-group-text bg-secondary border-secondary text-white">
                            <i class="bi bi-chat-dots-fill"></i>
                        </span>
                        <input type="text" name="body" 
                               class="form-control bg-secondary border-secondary text-white" 
                               placeholder="Type your message here...">
                    </div>
                    <button type="submit" class="btn btn-primary px-3">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Message List -->
            <div class="flex-grow-1 overflow-auto px-3 py-2" id="messageList">
                {% for message in room_messages %}
                <div class="d-flex align-items-start mb-3 {% if message.user == request.user %}justify-content-end{% endif %}">
                    {% if message.user != request.user %}
                    <img src="{{ message.user.avatar.url }}" 
                         class="rounded-circle me-2" style="object-fit: cover; width: 40px; height: 40px;" alt="User Avatar">
                    {% endif %}
                    <div class="{% if message.user == request.user %}bg-primary{% else %}bg-secondary{% endif %} rounded-3 p-2 px-3 message-bubble">
                        <div class="d-flex align-items-center {% if message.user == request.user %}justify-content-end{% endif %}">
                            <small class="text-white-50">@{{ message.user.name }}</small>
                            <small class="text-white-50 ms-2"><i class="bi bi-clock"></i> {{ message.created_at|date:"h:i A" }}</small>
                            {% if message.user == request.user %}
                            <div class="dropdown ms-2">
                                <a class="text-white-50" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuLink">
                                    <li>
                                        <form action="{% url 'delete-message' message.id %}" method="POST">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger">Delete</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        <p class="mb-0 text-white">{{ message.body }}</p>
                    </div>
                    {% if message.user == request.user %}
                    <img src="{{ message.user.avatar.url }}" 
                         class="rounded-circle ms-2" style="object-fit: cover; width: 32px; height: 32px;" alt="User Avatar">
                    {% endif %}
                </div>
                {% endfor %}
            </div>

        </div>
     
    </div>
</div>

{% endblock %}